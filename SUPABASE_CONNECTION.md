# Supabase Connection Keep-Alive System

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Supabase —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º keep-alive –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Keep-Alive
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- Heartbeat –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 2. –ê–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–≤—è–∑–∏
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –æ–∫–Ω–∞
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ "–ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### SupabaseManager Class

Singleton-–∫–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º Supabase –∫–ª–∏–µ–Ω—Ç–∞:

```typescript
class SupabaseManager {
  private client: SupabaseClient;
  private keepAliveInterval: number | null;
  private heartbeatInterval: number | null;
  private reconnectTimeout: number | null;
  private isReconnecting: boolean;

  // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
  private readonly KEEP_ALIVE_INTERVAL = 30000;  // 30 —Å–µ–∫
  private readonly HEARTBEAT_INTERVAL = 60000;   // 1 –º–∏–Ω
  private readonly RECONNECT_DELAY = 5000;       // 5 —Å–µ–∫
}
```

### –ú–µ—Ç–æ–¥—ã

#### `getClient()`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π Supabase –∫–ª–∏–µ–Ω—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

#### `executeQuery<T>(queryFn)`
–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö:

```typescript
const result = await executeQuery(async (client) => {
  return await client.from('table').select('*');
});
```

#### `checkConnection()`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—É—Ç–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

#### `reconnect()`
–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç Supabase –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
- –û—á–∏—â–∞–µ—Ç –≤—Å–µ –∫–∞–Ω–∞–ª—ã
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```typescript
import { getSupabase, executeQuery } from '@/lib/supabase';

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const supabase = getSupabase();
const { data } = await supabase.from('profiles').select('*');

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
const result = await executeQuery(async (client) => {
  return await client.from('profiles').select('*');
});
```

### –í —É—Ç–∏–ª–∏—Ç–∞—Ö

```typescript
import { getSupabase } from '@/lib/supabase';

export async function queryWithRetry<T>(queryFn, options) {
  return await executeQuery(async () => await queryFn());
}

export async function subscribeWithMonitoring(channelName, config) {
  const supabase = getSupabase();
  return supabase.channel(channelName)...;
}
```

### –í —Å–µ—Ä–≤–∏—Å–∞—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
private async initializeAuth() {
  const supabase = getSupabase();

  supabase.auth.onAuthStateChange((event, session) => {
    (async () => {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    })();
  });
}
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫:
- `Failed to fetch` - —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- `NetworkError` - –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
- `timeout` - —Ç–∞–π–º–∞—É—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏:
1. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
2. –ó–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º –∫–ª–∏–µ–Ω—Ç–æ–º
3. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—à–∏–±–∫–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å:
- `‚úÖ Subscribed: ${channelName}` - —É—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `üîÑ Reconnecting Supabase client...` - –Ω–∞—á–∞–ª–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `‚úÖ Supabase client reconnected successfully` - —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `‚ùå Reconnection failed, will retry...` - –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `‚ö†Ô∏è Heartbeat check failed, reconnecting...` - –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞

```typescript
createClient(url, key, {
  auth: {
    autoRefreshToken: true,    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    persistSession: true,       // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    detectSessionInUrl: true,   // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏–∑ URL
  },
  realtime: {
    params: {
      eventsPerSecond: 10,      // –õ–∏–º–∏—Ç —Å–æ–±—ã—Ç–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
    },
  },
})
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ getSupabase()** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ executeQuery()** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞** –Ω–∞–ø—Ä—è–º—É—é
4. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ onAuthStateChange** —á–µ—Ä–µ–∑ async –±–ª–æ–∫–∏
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ queryWithRetry()** –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

Keep-alive —Å–∏—Å—Ç–µ–º–∞ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (>2 –º–∏–Ω)
- Heartbeat –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ Supabase:
- Auth (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
- Database (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
- Storage (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
- Realtime (–ø–æ–¥–ø–∏—Å–∫–∏)
- Functions (edge functions)
